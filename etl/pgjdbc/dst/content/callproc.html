---
title: "Chapter 6. Calling Stored Functions"
draft: false
hidden: true
---
<div id="docContainerWrap">
 <div id="docContainer">
  <div id="docContent">
   <!-- NAVHEADER -->
   <div class="CHAPTER">
    <p>
     <strong>
      Table of Contents
     </strong>
    </p>
    <ul>
     <li>
      <a href="callproc.html#callproc-resultset">
       Obtaining a
       <code>
        ResultSet
       </code>
       from a stored function
      </a>
      <ul>
       <li>
        <a href="callproc.html#callproc-resultset-setof">
         From a Function Returning
         <code>
          SETOF
         </code>
         type
        </a>
       </li>
       <li>
        <a href="callproc.html#callproc-resultset-refcursor">
         From a Function Returning a refcursor
        </a>
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <a name="call-function-example">
     </a>
     <strong>
      Example 6.1. Calling a built in stored function
     </strong>
    </p>
    <p>
     This example shows how to call a PostgreSQL  built in function,
     <code>
      upper
     </code>
     , which
simply converts the supplied string argument to uppercase.
    </p>
    <div class="highlight">
     <pre><code class="language-java" data-lang="java"><span></span><span class="n">CallableStatement</span> <span class="n">upperProc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareCall</span><span class="o">(</span><span class="s">"{? = call upper( ? ) }"</span><span class="o">);</span>
<span class="n">upperProc</span><span class="o">.</span><span class="na">registerOutParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Types</span><span class="o">.</span><span class="na">VARCHAR</span><span class="o">);</span>
<span class="n">upperProc</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"lowercase to uppercase"</span><span class="o">);</span>
<span class="n">upperProc</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="n">String</span> <span class="n">upperCased</span> <span class="o">=</span> <span class="n">upperProc</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="n">upperProc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre>
    </div>
    <p>
     <a name="callproc-resultset">
     </a>
    </p>
    <h1>
     Obtaining a
     <code>
      ResultSet
     </code>
     from a stored function
    </h1>
    <p>
     PostgreSQL's  stored functions can return results in two different ways. The
function may return either a refcursor value or a
     <code>
      SETOF
     </code>
     some datatype.  Depending
on which of these return methods are used determines how the function should be
called.
    </p>
    <p>
     <a name="callproc-resultset-setof">
     </a>
    </p>
    <h2>
     From a Function Returning
     <code>
      SETOF
     </code>
     type
    </h2>
    <p>
     Functions that return data as a set should not be called via the
     <code>
      CallableStatement
     </code>
     interface, but instead should use the normal
     <code>
      Statement
     </code>
     or
     <code>
      PreparedStatement
     </code>
     interfaces.
    </p>
    <p>
     <a name="setof-resultset">
     </a>
     <strong>
      Example 6.2. Getting
      <code>
       SETOF
      </code>
      type values from a function
     </strong>
    </p>
    <div class="highlight">
     <pre><code class="language-java" data-lang="java"><span></span><span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
<span class="n">stmt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"CREATE OR REPLACE FUNCTION setoffunc() RETURNS SETOF int AS "</span>
    <span class="o">+</span> <span class="s">"' SELECT 1 UNION SELECT 2;' LANGUAGE sql"</span><span class="o">);</span>
<span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s">"SELECT * FROM setoffunc()"</span><span class="o">);</span>
<span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span>
<span class="o">{</span>
    <span class="c1">// do something</span>
<span class="o">}</span>
<span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre>
    </div>
    <p>
     <a name="callproc-resultset-refcursor">
     </a>
    </p>
    <h2>
     From a Function Returning a refcursor
    </h2>
    <p>
     When calling a function that returns a refcursor you must cast the return type of
     <code>
      getObject
     </code>
     to a
     <code>
      ResultSet
     </code>
    </p>
    <h3>
     Note
    </h3>
    <blockquote>
     <p>
      One notable limitation of the current support for a
      <code>
       ResultSet
      </code>
      created from
a refcursor is that even though it is a cursor backed
      <code>
       ResultSet
      </code>
      , all data will
be retrieved and cached on the client. The
      <code>
       Statement
      </code>
      fetch size parameter
described in the section called
      <a href="query.html#query-with-cursor">
       "Getting results based on a cursor"
      </a>
      is ignored. This limitation is a deficiency of the JDBC driver, not the server,
and it is technically possible to remove it, we just haven't found the time.
     </p>
    </blockquote>
    <p>
     <a name="get-refcursor-from-function-call">
     </a>
     <strong>
      Example 6.3. Getting refcursor Value From a Function
     </strong>
    </p>
    <div class="highlight">
     <pre><code class="language-java" data-lang="java"><span></span><span class="c1">// Setup function to call.</span>
<span class="n">Statement</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
<span class="n">stmt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"CREATE OR REPLACE FUNCTION refcursorfunc() RETURNS refcursor AS '"</span>
    <span class="o">+</span> <span class="s">" DECLARE "</span>
    <span class="o">+</span> <span class="s">"    mycurs refcursor; "</span>
    <span class="o">+</span> <span class="s">" BEGIN "</span>
    <span class="o">+</span> <span class="s">"    OPEN mycurs FOR SELECT 1 UNION SELECT 2; "</span>
    <span class="o">+</span> <span class="s">"    RETURN mycurs; "</span>
    <span class="o">+</span> <span class="s">" END;' language plpgsql"</span><span class="o">);</span>
<span class="n">stmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

<span class="c1">// We must be inside a transaction for cursors to work.</span>
<span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

<span class="c1">// Procedure call.</span>
<span class="n">CallableStatement</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareCall</span><span class="o">(</span><span class="s">"{? = call refcursorfunc() }"</span><span class="o">);</span>
<span class="n">proc</span><span class="o">.</span><span class="na">registerOutParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Types</span><span class="o">.</span><span class="na">OTHER</span><span class="o">);</span>
<span class="n">proc</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="n">ResultSet</span> <span class="n">results</span> <span class="o">=</span> <span class="o">(</span><span class="n">ResultSet</span><span class="o">)</span> <span class="n">proc</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="k">while</span> <span class="o">(</span><span class="n">results</span><span class="o">.</span><span class="na">next</span><span class="o">())</span>
<span class="o">{</span>
    <span class="c1">// do something with the results.</span>
<span class="o">}</span>
<span class="n">results</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">proc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre>
    </div>
    <p>
     It is also possible to treat the refcursor return value as a cursor name directly.
To do this, use the
     <code>
      getString
     </code>
     of
     <code>
      ResultSet
     </code>
     . With the underlying cursor name,
you are free to directly use cursor commands on it, such as
     <code>
      FETCH
     </code>
     and
     <code>
      MOVE
     </code>
     .
    </p>
    <p>
     <a name="refcursor-string-example">
     </a>
     <strong>
      Example 6.4. Treating refcursor as a cursor name
     </strong>
    </p>
    <div class="highlight">
     <pre><code class="language-java" data-lang="java"><span></span><span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">CallableStatement</span> <span class="n">proc</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareCall</span><span class="o">(</span><span class="s">"{? = call refcursorfunc() }"</span><span class="o">);</span>
<span class="n">proc</span><span class="o">.</span><span class="na">registerOutParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Types</span><span class="o">.</span><span class="na">OTHER</span><span class="o">);</span>
<span class="n">proc</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
<span class="n">String</span> <span class="n">cursorName</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="n">proc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre>
    </div>
   </div>
   <!-- NAVFOOTER -->
  </div>
  <!-- docContent -->
  <div id="docComments">
  </div>
  <!-- pgFooter -->
 </div>
 <!-- docContainer -->
</div>
<!-- docContainer -->
